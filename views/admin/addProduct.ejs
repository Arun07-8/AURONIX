<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Edit Product - Clean White Design</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
        <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
        <link href="/css/admin-css/addprod.css" rel="stylesheet">
    </head>
    <body>
        <%- include("../../views/partials/admin/header") %>
        <div class="main-content">
        <div class="header">
            <h1>Edit Product</h1>
            <div class="user-profile"></div>
        </div>
           <form id="editProductForm" enctype="multipart/form-data" onsubmit="return validateForm()">
          <input type="hidden" id="productId" name="productId" value="<%= product._id %>">

            <div class="container">
                <!-- Left Form Section -->
                <div class="form-section">
                    <h3>Product Details</h3>
                    <div class="form-group">
                        <label for="productName" class="required">Product Name</label>
                        <input type="text" id="productName" name="productName" class="form-control"
                            placeholder="Enter product name" value="">
                        <div id="productName-error" class="error-message"></div>
                    </div>
                    <div class="form-group">
                        <label for="description" class="required">Product Description</label>
                        <textarea id="description" name="description" class="form-control" rows="4"
                            placeholder="Enter product description"></textarea>
                        <div id="description-error" class="error-message"></div>
                    </div>
                    <div class="form-group">
                        <label for="brandId" class="required">Brand</label>
                        <select name="brand" class="form-control" id="brandId">
                            <option value="" >Select Brand</option>
                            <% for(let i=0; i < brand.length; i++) { %>
                                <option value="<%= brand[i]._id %>" <%= product && product.brand && product.brand._id.toString() === brand[i]._id.toString() ? 'selected' : '' %>>
                                    <%= brand[i].name %>
                                </option>
                            <% } %>
                        </select>
                        </select>
                        <div id="brandName-error" class="error-message"></div>
                    </div>
                    <div class="form-group">
                        <label for="categoryId" class="required">Category</label>
                        <select name="category" class="form-control" id="categoryId">
                              <option value="" >Select Category</option>
                            <% for(let i=0; i < category.length; i++) { %>
                                <option value="<%= category[i]._id %>" <%= product && product.category && product.category._id.toString() === category[i]._id.toString() ? 'selected' : '' %>>
                                    <%= category[i].name %>
                                </option>
                            <% } %>
                        </select>
                        <div id="category-error" class="error-message"></div>
                    </div>
                    <div class="form-group">
                        <label for="offerAmount" class="required">Offer Price</label>
                        <input type="number" id="offerAmount" name="salePrice" class="form-control"
                            placeholder="Enter offer price" value="">
                        <div id="offerPrice-error" class="error-message"></div>
                    </div>
                    <div class="form-group">
                        <label for="stockCount" class="required">Stock Count</label>
                        <input type="number" id="stockCount" name="quantity" class="form-control"
                            placeholder="Enter total stock count" value="">
                        <div id="quantity-error" class="error-message"></div>
                    </div>
                </div>

                <!-- Product Specifications Section -->
                <div class="specifications-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            <i class="fas fa-laptop"></i> Laptop Specifications
                        </h2>
                        <p class="section-subtitle">Enter essential laptop specifications</p>
                    </div>
                    <div class="specs-container">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">Processor</label>
                                <input type="text" class="form-control" id="processor" name="processor"
                                    placeholder="e.g., Intel Core i7-13700H"  value="">
                                <div id="processor-error" class="error-message"></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">Graphics Card</label>
                                <input type="text" class="form-control" id="gpu" name="graphicsCard"
                                    placeholder="e.g., NVIDIA RTX 4060"  value="">
                                <div id="graphicsCard-error" class="error-message"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">RAM</label>
                                <input type="text" class="form-control" id="ram" name="ram"
                                    placeholder="e.g., 16GB DDR5-5200"  value="">
                                <div id="ram-error" class="error-message"></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">Storage</label>
                                <input type="text" class="form-control" id="Storage" name="Storage"
                                    placeholder="e.g., 1TB PCIe NVMe SSD" value="">
                                <div id="Storage-error" class="error-message"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label required">Display</label>
                                <input type="text" class="form-control" id="display" name="display"
                                    placeholder="e.g., 15.6 inch IPS (2560x1440)" value="">
                                <div id="display-error" class="error-message"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label required">Operating System</label>
                                <input type="text" class="form-control" id="operatingSystem" name="operatingSystem"
                                    placeholder="e.g., Windows 11 Home" value="">
                                <div id="operatingSystem-error" class="error-message"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">Battery</label>
                                <input type="text" class="form-control" id="Battery" name="Battery"
                                    placeholder="e.g., 80Wh"  value="">
                                <div id="Battery-error" class="error-message"></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label required">Weight</label>
                                <input type="text" class="form-control" id="Weight" name="Weight"
                                    placeholder="e.g., 1.8kg"  value="">
                                <div id="Weight-error" class="error-message"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Additional Features</label>
                                <input type="text" class="form-control" id="additionalFeatures" name="additionalFeatures"
                                    placeholder="e.g., Backlit Keyboard" value="">
                                <div id="additionalFeatures-error" class="error-message"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label required">Warranty</label>
                                <input type="text" class="form-control" id="Warranty" name="Warranty"
                                    placeholder="e.g., 2 Year Limited Warranty"  value="">
                                <div id="Warranty-error" class="error-message"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Image Upload Section -->
                <div class="image-upload-container">
                    <h4>Product Images (Minimum 2, Maximum 5)</h4>
                    <div class="form-group">
                        <label for="images">Select Images</label>
                        <div class="drop-zone" id="dropZone">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 48px; margin-bottom: 15px; color: #bdc3c7;"></i><br>
                            Drag and drop images here or click to select<br>
                            <small>(Minimum 2, Maximum 5 images • JPEG, PNG, WebP • Max 5MB each)</small>
                        </div>
                        <input type="file" name="images" id="images" class="form-control" accept="image/jpeg,image/png,image/webp" multiple style="display: none;">
                        <div id="images-error" class="error-message"></div>
                    </div>
                    <div class="image-preview-container" id="imagePreviewContainer">
                        <p style="color: #7f8c8d; text-align: center; padding: 20px;">No images uploaded yet</p>
                    </div>
                    <div class="cropper-container" id="cropperContainer" style="display: none;">
                        <h5>Crop Image <span id="cropImageNumber"></span></h5>
                        <div class="cropper-wrapper">
                            <img id="cropperImg" alt="Image to crop">
                        </div>
                        <div class="aspect-ratio-controls">
                            <span>Aspect Ratio:</span>
                            <button type="button" class="aspect-ratio-btn active" data-ratio="free" onclick="setAspectRatio('free')">Free</button>
                            <button type="button" class="aspect-ratio-btn" data-ratio="30/37" onclick="setAspectRatio(30/37)">Fit Image</button>
                        </div>
                        <div class="cropper-controls">
                            <button type="button" class="btn btn-primary" onclick="cropImage()">
                                <i class="fas fa-check"></i> Apply Crop
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="cancelCrop()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                </div>
                <input type="hidden" value="" id="proID">
                <div class="button-container">
                    <button type="submit" class="add-btn">
                        <i class="fas fa-save"></i> Update Product
                    </button>
                    <a href="/admin/products">
                        <i class="fas fa-arrow-left"></i> Cancel
                    </a>
                </div>
            </div>
        </form> 
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script >
            let cropper = null;
    let currentImageIndex = -1;
    let isRecropping = false;
    let originalImages = [];
    let croppedImages = [];
    const minImages = 2;
    const maxImages = 5;
    const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];

    function sanitizeInput(input) {
        const div = document.createElement('div');
        div.textContent = input;
        return div.innerHTML.replace(/[<>&"]/g, '');
    }

    // Drag and Drop
    const dropZone = document.getElementById('dropZone');
    const imageInput = document.getElementById('images');
    dropZone.addEventListener('click', () => imageInput.click());
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });
    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });

    // File Input Change
    imageInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });
    function handleFiles(files) {
        clearErrorMessage('images');
        
        // Check if any files were provided
        if (!files || files.length === 0) {
            Swal.fire({
                icon: 'error',
                title: 'No Files Selected',
                text: 'Please select valid image files to upload.'
            });
            return;
        }

        const newFiles = Array.from(files).filter(file => 
            allowedTypes.includes(file.type) && file.size <= 5 * 1024 * 1024
        );

        // Check if any valid files remain after filtering
        if (newFiles.length === 0) {
            Swal.fire({
                icon: 'error',
                title: 'Invalid Files',
                text: 'Only JPEG, PNG, or WebP images up to 5MB are allowed.'
            });
            return;
        }

        // Calculate total images
        const totalImages = croppedImages.length + newFiles.length;

        // Check minimum images
        if (totalImages < minImages) {
       
            
            Swal.fire({
                icon: 'error',
                title: 'Insufficient Images',
                text: `You have ${croppedImages.length} images. Please add at least ${minImages - croppedImages.length} more images to meet the minimum requirement of ${minImages}.`
            });
            return;
        }

        // Check maximum images
        if (totalImages > maxImages) {
            
            Swal.fire({
                icon: 'error',
                title: 'Maximum Images Exceeded',
                text: `You have selected ${totalImages} images. Please select ${maxImages - croppedImages.length} or fewer images to stay within the maximum limit of ${maxImages}.`
            });
            return;
        }

        // Append new files to originalImages
        newFiles.forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                originalImages.push({ file, dataUrl: e.target.result });
                console.log(`Added file to originalImages. Total originalImages: ${originalImages.length}`); // Debugging
                // Start cropping only for the newly added images
                if (originalImages.length === croppedImages.length + newFiles.length) {
                    updatePreview();
                    startCrop(croppedImages.length); // Start cropping from the first new image
                }
            };
            reader.readAsDataURL(file);
        });
    }
    function removeImage(index) {
        croppedImages.splice(index, 1);
        originalImages.splice(index, 1);
        updatePreview();
        updateFormFiles();
        // Reset file input to allow new uploads
        imageInput.value = '';
        if (croppedImages.length < minImages) {
            Swal.fire({
                icon: 'error',
                title: 'Insufficient Images',
                text: `You have ${croppedImages.length} images. Please add at least ${minImages - croppedImages.length} more images to meet the minimum requirement of ${minImages}.`
            });
        }
    }

    function updateFormFiles() {
        const dataTransfer = new DataTransfer();
        croppedImages.forEach(img => dataTransfer.items.add(img.file));
        imageInput.files = dataTransfer.files;
    }

    function updatePreview() {
        const previewContainer = document.getElementById('imagePreviewContainer');
        previewContainer.innerHTML = '';
        
        if (croppedImages.length > 0) {
            // Main Image (First Image)
            const mainImageDiv = document.createElement('div');
            mainImageDiv.className = 'main-image-preview';
            mainImageDiv.innerHTML = `
                <img src="${croppedImages[0].dataUrl}" alt="Main Preview">
                <div class="preview-controls">
                    <button type="button" class="recrop-btn" onclick="recropImage(0)" title="Recrop"><i class="fas fa-crop-alt"></i></button>
                    <button type="button" class="remove-btn" onclick="removeImage(0)" title="Remove">×</button>
                </div>
            `;
            previewContainer.appendChild(mainImageDiv);

            // Secondary Images (2nd, 3rd, 4th, etc.)
            if (croppedImages.length > 1) {
                const secondaryImagesDiv = document.createElement('div');
                secondaryImagesDiv.className = 'secondary-images';
                croppedImages.slice(1).forEach((img, index) => {
                    const secondaryImageDiv = document.createElement('div');
                    secondaryImageDiv.className = 'secondary-image-preview';
                    secondaryImageDiv.innerHTML = `
                        <img src="${img.dataUrl}" alt="Secondary Preview ${index + 2}">
                        <div class="preview-controls">
                            <button type="button" class="recrop-btn" onclick="recropImage(${index + 1})" title="Recrop"><i class="fas fa-crop-alt"></i></button>
                            <button type="button" class="remove-btn" onclick="removeImage(${index + 1})" title="Remove">×</button>
                        </div>
                    `;
                    secondaryImagesDiv.appendChild(secondaryImageDiv);
                });
                previewContainer.appendChild(secondaryImagesDiv);
            }
        }
    }

    function startCrop(index) {
        if (index >= originalImages.length) return;
        currentImageIndex = index;
        const cropperContainer = document.getElementById('cropperContainer');
        const cropperImg = document.getElementById('cropperImg');
        const cropImageNumber = document.getElementById('cropImageNumber');
        cropperImg.src = originalImages[index].dataUrl;
        cropImageNumber.textContent = isRecropping ? `(Recropping Image ${index + 1})` : `(${index + 1} of ${originalImages.length})`;
        cropperContainer.style.display = 'block';

        if (cropper) cropper.destroy();
        cropper = new Cropper(cropperImg, {
            viewMode: 1,
            dragMode: 'crop',
            responsive: true,
            restore: false,
            center: true,
            highlight: true,
            background: true,
            autoCrop: true,
            autoCropArea: 0.8,
            movable: true,
            rotatable: false,
            scalable: true,
            zoomable: true,
            zoomOnTouch: true,
            zoomOnWheel: true,
            aspectRatio: NaN
        });

        setActiveAspectRatioButton('free');
    }

    function recropImage(index) {
        isRecropping = true;
        startCrop(index);
    }

    function setAspectRatio(ratio) {
        if (cropper) {
            cropper.setAspectRatio(ratio === 'free' ? NaN : ratio);
            setActiveAspectRatioButton(ratio);
        }
    }

    function setActiveAspectRatioButton(ratio) {
        document.querySelectorAll('.aspect-ratio-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.aspect-ratio-btn[data-ratio="${ratio}"]`).classList.add('active');
    }

    function cropImage() {
        if (!cropper) return;
        const cropData = cropper.getData();
        if (cropData.width < 256 || cropData.height < 256) {
            Swal.fire({
                icon: 'error',
                title: 'Invalid Crop',
                text: 'Cropped image must be at least 256x256 pixels.'
            });
            return;
        }

        const croppedCanvas = cropper.getCroppedCanvas({
            minWidth: 256,
            minHeight: 256,
            maxWidth: 4096,
            maxHeight: 4096,
            fillColor: '#fff',
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high'
        });

        const file = originalImages[currentImageIndex].file;
        const mimeType = file.type;
        const extension = mimeType.split('/')[1];

        croppedCanvas.toBlob((blob) => {
            const croppedFile = new File([blob], `cropped_image_${currentImageIndex}.${extension}`, {
                type: mimeType,
                lastModified: Date.now()
            });
            croppedImages[currentImageIndex] = {
                file: croppedFile,
                dataUrl: croppedCanvas.toDataURL(mimeType)
            };
            updatePreview();
            cropper.destroy();
            cropper = null;
            document.getElementById('cropperContainer').style.display = 'none';
            updateFormFiles();
            if (!isRecropping && currentImageIndex + 1 < originalImages.length) {
                startCrop(currentImageIndex + 1);
            }
            isRecropping = false;
        }, mimeType, 0.9);
    }

    function cancelCrop() {
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        document.getElementById('cropperContainer').style.display = 'none';
        if (!isRecropping) {
            originalImages = [];
            croppedImages = [];
            imageInput.value = '';
        }
        updatePreview();
        updateFormFiles();
        isRecropping = false;
    }


document.getElementById('editProductForm').addEventListener('submit', async function (event) {
    event.preventDefault();
    if (validateForm()) {
        const form = this;
        const formData = new FormData(form);
        console.log('FormData contents:');
        for (const [key, value] of formData.entries()) {
            console.log(`${key}:`, value);
        }
        Swal.fire({
            title: 'Processing...',
            text: 'Updating your product',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        try {
            const response = await fetch('/admin/addProduct', {
                method: 'POST',
                body: formData,
            });
            const result = await response.json();
            if (response.ok) {
                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: result.message || 'Product updated successfully!',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    window.location.href = '/admin/products';
                });
            } else {
                console.error('Server error:', await response.text());
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: result.error || 'Failed to update product.'
                });
            }
        } catch (error) {
            console.error('Fetch error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: `An unexpected error occurred: ${error.message}. Please try again.`
            });
        }
    } else {
        const firstInvalid = document.querySelector('.is-invalid');
        if (firstInvalid) {
            firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        Swal.fire({
            icon: 'error',
            title: 'Validation Error',
            text: 'Please correct the errors in the form before submitting.'
        });
    }
});

function validateForm() {
    clearErrorMessages();
    let isValid = true;
    let firstInvalidField = null;

    const fields = [
        { id: 'productName', validate: (value) => {
            value = sanitizeInput(value);
            if (!value) return 'Product name is required.';
            const wordCount = value.trim().split(/\s+/).length;
            if (wordCount < 3) return 'Product name must contain at least 3 words.';
            return '';
        }},
        { id: 'description', validate: (value) => {
            value = sanitizeInput(value);
            if (!value) return 'Description is required.';
            const wordCount = value.trim().split(/\s+/).length;
            if (wordCount < 5) return 'Description must contain at least 5 words.';
            return '';
        }},
        { id: 'brandId', validate: (value) => !value ? 'Please select a brand.' : '' }, // Corrected ID
        { id: 'categoryId', validate: (value) => !value ? 'Please select a category.' : '' }, // Corrected ID
        
        { id: 'offerAmount', validate: (value) => { // Corrected ID to match input
            if (!value) return 'Offer price is required.';
            const price = parseFloat(value);
            if (isNaN(price) || price < 15000 || price > 150000) return 'Offer price must be between 15000 and 150,000.';
            return '';
        }},
        { id: 'stockCount', validate: (value) => { // Corrected ID to match input
            if (!value) return 'Stock count is required.';
            const qty = parseInt(value);
            if (isNaN(qty) || qty < 0 || qty > 1000) return 'Stock count must be between 0 and 1,000.';
            return '';
        }},
        { id: 'processor', validate: (value) => {
            value = sanitizeInput(value);
            if (!value) return 'Processor is required.';
            const wordCount = value.trim().split(/\s+/).length;
            if (wordCount < 2) return 'Processor must contain at least 2 words.';
            return '';
        }},
        { id: 'gpu', validate: (value) => { // Corrected ID to match input
            value = sanitizeInput(value);
            if (!value) return 'Graphics card is required.';
            const wordCount = value.trim().split(/\s+/).length;
            if (wordCount < 2) return 'Graphics card must contain at least 2 words.';
            return '';
        }},
        { id: 'ram', validate: (value) => {
            value = sanitizeInput(value);
            if (!value) return 'RAM is required.';
            const wordCount = value.trim().split(/\s+/).length;
            if (wordCount < 2) return 'RAM must contain at least 2 words.';
            return '';
        }},
        { id: 'Storage', validate: (value) => {
            value = sanitizeInput(value);
            if (!value) return 'Storage is required.';
            const wordCount = value.trim().split(/\s+/).length;
            if (wordCount < 2) return 'Storage must contain at least 2 words.';
            return '';
        }},
        { id: 'display', validate: (value) => {
            value = sanitizeInput(value);
            if (!value) return 'Display is required.';
            const wordCount = value.trim().split(/\s+/).length;
            if (wordCount < 2) return 'Display must contain at least 2 words.';
            return '';
        }},
        { id: 'operatingSystem', validate: (value) => {
            value = sanitizeInput(value);
            if (!value) return 'Operating system is required.';
            const wordCount = value.trim().split(/\s+/).length;
            if (wordCount < 2) return 'Operating system must contain at least 2 words.';
            return '';
        }},
        { id: 'Battery', validate: (value) => {
            value = sanitizeInput(value);
            if (!value) return 'Battery is required.';
            const wordCount = value.trim().split(/\s+/).length;
            if (wordCount < 2) return 'Battery must contain at least 2 words.';
            return '';
        }},
        { id: 'Weight', validate: (value) => {
            value = sanitizeInput(value);
            if (!value) return 'Weight is required.';
            const wordCount = value.trim().split(/\s+/).length;
            if (wordCount < 2) return 'Weight must contain at least 2 words.';
            return '';
        }},
        { id: 'Warranty', validate: (value) => {
            value = sanitizeInput(value);
            if (!value) return 'Warranty is required.';
            const wordCount = value.trim().split(/\s+/).length;
            if (wordCount < 2) return 'Warranty must contain at least 2 words.';
            return '';
        }},
        { id: 'additionalFeatures', validate: (value) => {
            value = sanitizeInput(value);
            if (value && value.trim().split(/\s+/).length < 2) return 'Additional features must contain at least 2 words.';
            return '';
        }}
    ];

    fields.forEach(field => {
        const element = document.getElementById(field.id);
        if (!element) {
            console.error(`Element with ID ${field.id} not found.`);
            isValid = false;
            return;
        }
        const value = element.value.trim();
        const errorMessage = field.validate(value);
        if (errorMessage) {
            displayErrorMessage(field.id, errorMessage);
            element.classList.add('is-invalid');
            if (!firstInvalidField) firstInvalidField = element;
            isValid = false;
        }
    });


    const salePrice = parseFloat(document.getElementById('offerAmount').value);

    if (croppedImages.length < minImages) {
        Swal.fire({
            icon: 'error',
            title: 'Insufficient Images',
            text: `You have ${croppedImages.length} images. Please add at least ${minImages - croppedImages.length} more images to meet the minimum requirement of ${minImages}.`
        });
        displayErrorMessage('images', `Please upload and crop at least ${minImages} images (maximum ${maxImages}).`);
        document.getElementById('images').classList.add('is-invalid');
        if (!firstInvalidField) firstInvalidField = document.getElementById('images');
        isValid = false;
    } else if (croppedImages.length > maxImages) {
        Swal.fire({
            icon: 'error',
            title: 'Maximum Images Exceeded',
            text: `You have ${croppedImages.length} images. Please remove ${croppedImages.length - maxImages} image(s) to stay within the maximum limit of ${maxImages}.`
        });
        displayErrorMessage('images', `You have uploaded ${croppedImages.length} images. Please remove ${croppedImages.length - maxImages} image(s) to stay within the maximum limit of ${maxImages}.`);
        document.getElementById('images').classList.add('is-invalid');
        if (!firstInvalidField) firstInvalidField = document.getElementById('images');
        isValid = false;
    }

    return isValid;
}
    function displayErrorMessage(id, message) {
        const errorElement = document.getElementById(`${id}-error`);
        if (errorElement) {
            errorElement.textContent = message;
            errorElement.classList.add('active');
            errorElement.style.display = 'block';
        }
    }

    function clearErrorMessage( id) {
        const errorElement = document.getElementById(`${id}-error`);
        if (errorElement) {
            errorElement.textContent = '';
            errorElement.classList.remove('active');
            errorElement.style.display = 'none';
        }
        const element = document.getElementById(id);
        if (element) {
            element.classList.remove('is-invalid');
        }
    }

    function clearErrorMessages() {
        const errorElements = document.getElementsByClassName('error-message');
        for (let element of errorElements) {
            element.textContent = '';
            element.classList.remove('active');
            element.style.display = 'none';
        }
        const inputs = document.querySelectorAll('input, select, textarea');
        for (let input of inputs) {
            input.classList.remove('is-invalid');
        }
    }
    </script>
</body>
</html>